@model Farm_Management.Models.ViewModels.AttendanceCalendarViewModel
@{
    ViewData["Title"] = $"Chấm công tháng {Model.Month}/{Model.Year}";
    var monthName = new DateTime(Model.Year, Model.Month, 1).ToString("MMMM", new System.Globalization.CultureInfo("vi-VN"));
}

<div class="row mb-3">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h2>📅 Chấm công - @monthName @Model.Year</h2>
            <div class="btn-group">
                <a asp-action="Calendar"
                   asp-route-year="@(Model.Month == 1 ? Model.Year - 1 : Model.Year)"
                   asp-route-month="@(Model.Month == 1 ? 12 : Model.Month - 1)"
                   class="btn btn-outline-secondary">
                    ◀ Tháng trước
                </a>
                <a asp-action="Calendar"
                   class="btn btn-outline-primary">
                    📆 Hôm nay
                </a>
                <a asp-action="Calendar"
                   asp-route-year="@(Model.Month == 12 ? Model.Year + 1 : Model.Year)"
                   asp-route-month="@(Model.Month == 12 ? 1 : Model.Month + 1)"
                   class="btn btn-outline-secondary">
                    Tháng sau ▶
                </a>
            </div>
        </div>

        <!-- Quick legend -->
        <div class="alert alert-info mt-2 mb-0">
            <strong>💡 Hướng dẫn:</strong>
            <span class="badge bg-success">≥ 8 giờ = 1 công</span>
            <span class="badge bg-warning text-dark">= 4 giờ = 0.5 công</span>
            <span class="badge bg-info">< 4 giờ = Giờ lẻ</span>
            <span class="badge bg-secondary">0 = Nghỉ</span>
            | Nhập số giờ rồi nhấn Tab/Enter hoặc click ra ngoài để lưu tự động
        </div>
    </div>
</div>

@if (!Model.Workers.Any())
{
    <div class="alert alert-warning">
        ⚠️ Chưa có công nhân nào. Vui lòng thêm công nhân trước.
    </div>
}
else
{
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-bordered table-sm table-hover attendance-calendar mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th class="sticky-col bg-light" style="min-width: 150px; z-index: 20;">
                                Công nhân
                            </th>
                            @for (int day = 1; day <= Model.DaysInMonth; day++)
                            {
                                var date = new DateTime(Model.Year, Model.Month, day);
                                var isWeekend = date.DayOfWeek == DayOfWeek.Saturday || date.DayOfWeek == DayOfWeek.Sunday;
                                var isToday = date == DateTime.Today;

                                <th class="text-center @(isWeekend ? "bg-weekend" : "") @(isToday ? "bg-today" : "")"
                                    style="min-width: 55px; padding: 4px 2px;">
                                    <div class="fw-bold">@day</div>
                                    <small class="text-muted">@date.ToString("ddd", new System.Globalization.CultureInfo("vi-VN"))</small>
                                </th>
                            }
                            <th class="text-center" style="min-width: 120px;">
                                <div class="fw-bold">Tổng</div>
                                <small class="text-muted">Công | Giờ lẻ</small>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var worker in Model.Workers)
                        {
                            var summary = Model.GetWorkerSummary(worker.Id);

                            <tr>
                                <td class="sticky-col bg-white fw-bold align-middle" style="z-index: 10;">
                                    <div class="text-primary">@worker.Code</div>
                                    <small class="text-muted">@worker.FullName</small>
                                </td>

                                @for (int day = 1; day <= Model.DaysInMonth; day++)
                                {
                                    var hours = Model.GetHours(worker.Id, day);
                                    var workType = Model.GetWorkType(worker.Id, day);
                                    var date = new DateTime(Model.Year, Model.Month, day);
                                    var cellClass = workType == "FullDay" ? "cell-full" :
                                    workType == "HalfDay" ? "cell-half" :
                                    workType == "OddHours" ? "cell-odd" : "";
                                    var isWeekend = date.DayOfWeek == DayOfWeek.Saturday || date.DayOfWeek == DayOfWeek.Sunday;

                                    <td class="p-1 text-center @(isWeekend ? "bg-weekend-cell" : "")" style="position: relative;">
                                        <input type="number"
                                               class="form-control form-control-sm text-center hours-cell @cellClass"
                                               data-worker-id="@worker.Id"
                                               data-date="@date.ToString("yyyy-MM-dd")"
                                               value="@(hours == 0 ? "" : hours.ToString("0.##"))"
                                               min="0"
                                               max="24"
                                               step="0.5"
                                               placeholder="-"
                                               title="@worker.FullName - @date.ToString("dd/MM/yyyy")" />
                                        <div class="save-indicator">💾</div>
                                    </td>
                                }

                                <td class="text-center align-middle fw-bold" style="background: #f8f9fa;">
                                    <div>
                                        <span class="badge bg-success" style="font-size: 0.9rem;">
                                            @summary.TotalDays công
                                        </span>
                                    </div>
                                    @if (summary.OddHours > 0)
                                    {
                                        <div class="mt-1">
                                            <span class="badge bg-info" style="font-size: 0.85rem;">
                                                @summary.OddHours.ToString("0.##") giờ lẻ
                                            </span>
                                        </div>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Summary footer -->
        <div class="card-footer bg-light">
            <div class="row">
                <div class="col-md-4">
                    <strong>📊 Tổng số công nhân:</strong> @Model.Workers.Count
                </div>
                <div class="col-md-4">
                    @{
                        var allLogs = Model.Logs.Values.ToList();
                        var totalFullDays = allLogs.Count(l => l.WorkType == "FullDay");
                        var totalHalfDays = allLogs.Count(l => l.WorkType == "HalfDay");
                        var totalOddHours = allLogs.Where(l => l.WorkType == "OddHours").Sum(l => l.HoursWorked);
                        var totalDays = totalFullDays + (totalHalfDays * 0.5m);
                    }
                    <strong>📈 Tổng công trong tháng:</strong> @totalDays công
                </div>
                <div class="col-md-4">
                    <strong>⏱️ Tổng giờ lẻ:</strong> @totalOddHours.ToString("0.##") giờ
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function() {

            // Auto-save khi blur (click ra ngoài hoặc nhấn Tab)
            $('.hours-cell').on('blur', function() {
                var $input = $(this);
                var workerId = $input.data('worker-id');
                var date = $input.data('date');
                var hours = parseFloat($input.val()) || 0;

                // Hiển thị indicator
                $input.siblings('.save-indicator').fadeIn(100);

                // Save via AJAX
                $.ajax({
                    url: '@Url.Action("SaveCell", "Attendance")',
                    type: 'POST',
                    data: {
                        workerId: workerId,
                        date: date,
                        hours: hours
                    },
                    success: function(result) {
                        if (result.success) {
                            // Update cell color
                            $input.removeClass('cell-full cell-half cell-odd');

                            if (result.workType === 'FullDay') {
                                $input.addClass('cell-full');
                            } else if (result.workType === 'HalfDay') {
                                $input.addClass('cell-half');
                            } else if (result.workType === 'OddHours') {
                                $input.addClass('cell-odd');
                            }

                            // Ẩn indicator sau 500ms
                            setTimeout(function() {
                                $input.siblings('.save-indicator').fadeOut(200);
                            }, 500);

                            // TODO: Update summary column (có thể reload row hoặc tính lại bằng JS)
                        } else {
                            alert('Lỗi: ' + result.message);
                            $input.siblings('.save-indicator').fadeOut(200);
                        }
                    },
                    error: function() {
                        alert('Không thể kết nối server!');
                        $input.siblings('.save-indicator').fadeOut(200);
                    }
                });
            });

            // Real-time color update khi đang gõ
            $('.hours-cell').on('input', function() {
                var hours = parseFloat($(this).val()) || 0;
                $(this).removeClass('cell-full cell-half cell-odd');

                if (hours >= 8) {
                    $(this).addClass('cell-full');
                } else if (hours === 4) {
                    $(this).addClass('cell-half');
                } else if (hours > 0 && hours < 4) {
                    $(this).addClass('cell-odd');
                }
            });

            // Enter key → blur (trigger save)
            $('.hours-cell').on('keypress', function(e) {
                if (e.which === 13) { // Enter key
                    $(this).blur();
                }
            });

            // Keyboard navigation: Tab giữa các cells
            $('.hours-cell').on('keydown', function(e) {
                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft' ||
                    e.key === 'ArrowUp' || e.key === 'ArrowDown') {

                    var $current = $(this);
                    var $cells = $('.hours-cell');
                    var currentIndex = $cells.index($current);
                    var $target;

                    if (e.key === 'ArrowRight') {
                        $target = $cells.eq(currentIndex + 1);
                    } else if (e.key === 'ArrowLeft') {
                        $target = $cells.eq(currentIndex - 1);
                    } else if (e.key === 'ArrowDown') {
                        $target = $cells.eq(currentIndex + @Model.DaysInMonth + 1); // +1 for summary column
                    } else if (e.key === 'ArrowUp') {
                        $target = $cells.eq(currentIndex - @Model.DaysInMonth - 1);
                    }

                    if ($target && $target.length) {
                        e.preventDefault();
                        $target.focus().select();
                    }
                }
            });
        });
    </script>

    <style>
        /* Table styling */
        .attendance-calendar {
            font-size: 0.85rem;
            border-collapse: separate;
            border-spacing: 0;
        }

        .attendance-calendar thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
            border: 1px solid #dee2e6;
            padding: 8px 4px;
        }

        /* Sticky first column */
        .sticky-col {
            position: sticky;
            left: 0;
            background: white !important;
            z-index: 15;
            border-right: 2px solid #dee2e6 !important;
        }

        /* Cell input styling */
        .hours-cell {
            width: 50px;
            height: 32px;
            border: 1px solid #ced4da;
            padding: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .hours-cell:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
            z-index: 5;
        }

        /* Work type colors */
        .cell-full {
            background-color: #d4edda !important;
            border-color: #28a745 !important;
        }

        .cell-half {
            background-color: #fff3cd !important;
            border-color: #ffc107 !important;
        }

        .cell-odd {
            background-color: #d1ecf1 !important;
            border-color: #17a2b8 !important;
        }

        /* Weekend styling */
        .bg-weekend {
            background-color: #f0f0f0 !important;
        }

        .bg-weekend-cell {
            background-color: #fafafa !important;
        }

        /* Today highlight */
        .bg-today {
            background-color: #fff3cd !important;
            font-weight: bold;
        }

        /* Save indicator */
        .save-indicator {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            display: none;
            opacity: 0.7;
        }

    </style>
}